rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Deny all reads and writes by default for security.
    match /{document=**} {
      allow read, write: if false;
    }

    // Function to check if a user belongs to a specific tenant.
    function isTenantMember(tenantId) {
      return request.auth != null && request.auth.token.tenantId == tenantId;
    }

    // Users can read/write their own profile.
    // New users can be created by an authenticated user from the same tenant (e.g., invites).
    match /users/{userId} {
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.token.tenantId == request.resource.data.tenantId;
    }

    // Generic rule for all tenant-specific collections.
    // This rule ensures data isolation between tenants.
    function tenantDataAccess() {
      return {
        // Allow reading documents that belong to the user's tenant.
        allow read: if isTenantMember(resource.data.tenantId),
        
        // Allow creating new documents, ensuring the tenantId is correctly set and not spoofed.
        allow create: if isTenantMember(request.resource.data.tenantId),

        // Allow updates only if the tenantId is NOT being changed.
        allow update: if isTenantMember(resource.data.tenantId) && request.resource.data.tenantId == resource.data.tenantId,

        // Allow deleting documents that belong to the user's tenant.
        allow delete: if isTenantMember(resource.data.tenantId)
      }
    }

    match /assets/{assetId} { rules: tenantDataAccess() }
    match /maintenance/{maintenanceId} { rules: tenantDataAccess() }
    match /suppliers/{supplierId} { rules: tenantDataAccess() }
    match /stock/{stockId} { rules: tenantDataAccess() }
    match /projects/{projectId} { rules: tenantDataAccess() }
    match /documents/{documentId} { rules: tenantDataAccess() }
    match /sales/{saleId} { rules: tenantDataAccess() }
    match /purchasing/{purchaseId} { rules: tenantDataAccess() }
    match /crm/{crmId} { rules: tenantDataAccess() }
    match /hr/{hrId} { rules: tenantDataAccess() }
    match /finance/{financeId} { rules: tenantDataAccess() }
    
    // Tenant metadata is readable by its members but not writable from the client.
    match /tenants/{tenantId} {
        allow read: if isTenantMember(tenantId);
        allow write: if false; // Should only be written by trusted backend processes.
    }

    // The mail collection is write-only for backend services.
    match /mail/{mailId} {
        allow read: if false;
        allow write: if request.auth == null; // Indicates a backend (unauthenticated) request.
    }

    // Chat messages can be read/created by tenant members.
    // Users can only edit or delete their own messages.
    match /chats/{tenantId}/messages/{messageId} {
        allow read, create: if isTenantMember(tenantId);
        allow update, delete: if isTenantMember(tenantId) && resource.data.senderId == request.auth.uid;
    }
  }
}
